syntax = "proto3";

package Inventory;

option csharp_namespace = "QuantumCartAI.Service.Cart.proto";

// ──────────────────────────────────────────────────────────────
// 1. INVENTORY QUERY SERVICE (used by Cart, Checkout, PDP, etc.)
// ──────────────────────────────────────────────────────────────
service InventoryQueryService {
  // Get current Available-to-Promise (ATP) for one SKU
  rpc GetAtp (GetAtpRequest) returns (GetAtpResponse);

  // Batch version – used heavily on PDP / search pages
  rpc GetAtpBatch (GetAtpBatchRequest) returns (GetAtpBatchResponse);

  // Optional: stream real-time ATP changes (post-MVP)
  // rpc SubscribeAtpChanges (SubscribeAtpRequest) returns (stream AtpChanged);
}

// ──────────────────────────────────────────────────────────────
// 2. COMMAND SERVICE (used by Cart → reserve/release)
// ──────────────────────────────────────────────────────────────
service InventoryCommandService {
  // Soft-reserve (15 min) – called from Cart.AddItem
  rpc Reserve (ReserveRequest) returns (ReserveResponse);

  // Confirm reserve → hard allocation (on order placement)
  rpc CommitReserve (CommitReserveRequest) returns (CommitReserveResponse);

  // Release soft-reserve (remove item, timeout, checkout cancel)
  rpc Release (ReleaseRequest) returns (ReleaseResponse);
}

// ──────────────────────────────────────────────────────────────
// Messages – Query
// ──────────────────────────────────────────────────────────────
message GetAtpRequest {
  string sku_id = 1;
  // Optional: warehouse / DC override (for split-shipment preview)
  string warehouse_id = 2;
}

message GetAtpResponse {
  // Available-to-Promise right now
  int32 atp = 1;
  // When the next stock becomes available (for back-order UI)
  google.protobuf.Timestamp next_available_at = 2;
}

message GetAtpBatchRequest {
  repeated string sku_ids = 1;
  string warehouse_id = 2;
}

message GetAtpBatchResponse {
  map<string, int32> atp_by_sku = 1;
}

// ──────────────────────────────────────────────────────────────
// Messages – Command (reserve flow)
// ──────────────────────────────────────────────────────────────
message ReserveRequest {
  string reservation_id = 1;     // Guid from Cart (correlation)
  string cart_id = 2;            // For debugging / analytics
  repeated ReserveItem items = 3;
  google.protobuf.Timestamp expires_at = 4;  // 15 min from now
}

message ReserveItem {
  string sku_id = 1;
  int32 quantity = 2;
  string warehouse_id = 3;       // Optional – let Inventory pick best DC
}

message ReserveResponse {
  enum Status {
    UNKNOWN = 0;
    SUCCESS = 1;
    PARTIAL = 2;     // Some items got less than requested
    FAILED = 3;
  }
  Status status = 1;
  repeated ReserveResult results = 2;
  string reservation_id = 3;
}

message ReserveResult {
  string sku_id = 1;
  int32 requested_quantity = 2;
  int32 reserved_quantity = 3;   // ≤ requested_quantity
  string warehouse_id = 4;
}

message CommitReserveRequest {
  string reservation_id = 1;
}

message CommitReserveResponse {
  bool success = 1;
  string failure_reason = 2;
}

message ReleaseRequest {
  string reservation_id = 1;
  // Optional: release only specific SKUs
  repeated string sku_ids = 2;
}

message ReleaseResponse {
  bool success = 1;
}

// ──────────────────────────────────────────────────────────────
// Common
// ──────────────────────────────────────────────────────────────
import "google/protobuf/timestamp.proto";